<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çº¯GitHubå¤šäººæ¶‚é¸¦ ğŸ¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#8B5CF6',
                        secondary: '#EC4899',
                        neutral: '#1F2937',
                    },
                    fontFamily: {
                        comic: ['"Comic Sans MS"', '"Chalkboard SE"', 'cursive'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .brush-shadow { box-shadow: 0 0 12px rgba(139, 92, 246, 0.6); }
            .pulse { animation: pulse 2s infinite; }
            .float { animation: float 3s ease-in-out infinite; }
            .bubble { animation: bubble 0.4s ease-out; }
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes float { 0% { transform: translateY(0); } 50% { transform: translateY(-8px); } 100% { transform: translateY(0); } }
        @keyframes bubble { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        canvas { touch-action: none; cursor: crosshair; }
        .tool-btn.active { @apply bg-primary text-white brush-shadow; }
        .color-btn.active { @apply ring-2 ring-primary ring-offset-1; }
        .chat-self { @apply bg-primary text-white rounded-tl-2xl rounded-tr-md rounded-bl-2xl; }
        .chat-other { @apply bg-gray-200 rounded-tr-2xl rounded-tl-md rounded-br-2xl; }
    </style>
</head>
<body class="bg-gray-50 font-comic text-neutral min-h-screen flex flex-col">
    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <header class="bg-white shadow-md py-3 px-4 sticky top-0 z-40">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i class="fa fa-paint-brush text-primary text-2xl float"></i>
                <h1 class="text-xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
                    GitHubå¤šäººæ¶‚é¸¦ ğŸ¨
                </h1>
            </div>
            <div id="room-status" class="hidden items-center gap-2 text-sm">
                <span class="bg-primary/10 px-2 py-1 rounded-full">
                    æˆ¿é—´: <span id="room-id" class="font-bold"></span>
                </span>
                <span class="bg-green-100 text-green-700 px-2 py-1 rounded-full">
                    åœ¨çº¿: <span id="online-count">1</span>
                </span>
            </div>
        </div>
    </header>

    <!-- åˆå§‹é¡µé¢ï¼ˆåˆ›å»º/åŠ å…¥æˆ¿é—´ï¼‰ -->
    <div id="init-screen" class="flex-1 flex flex-col items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 w-full max-w-md float">
            <h2 class="text-2xl font-bold text-center mb-6 text-primary">å¼€å§‹æ¶‚é¸¦ä¹‹æ—…ï¼</h2>
            
            <!-- åˆ›å»ºæˆ¿é—´ -->
            <button id="create-room-btn" class="w-full bg-primary text-white py-3 rounded-xl font-bold mb-4 hover:bg-primary/90 transition pulse flex items-center justify-center gap-2">
                <i class="fa fa-plus-circle"></i> åˆ›å»ºæ–°æˆ¿é—´
            </button>
            
            <!-- åŠ å…¥æˆ¿é—´ -->
            <div class="mb-6">
                <label class="block text-sm font-medium mb-2 text-center">è¾“å…¥æˆ¿é—´IDåŠ å…¥</label>
                <div class="flex gap-2">
                    <input type="text" id="join-room-id" placeholder="ä¾‹å¦‚ï¼šabc123" class="flex-1 px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary">
                    <button id="join-room-btn" class="bg-secondary text-white px-4 rounded-xl hover:bg-secondary/90 transition">
                        <i class="fa fa-sign-in"></i> åŠ å…¥
                    </button>
                </div>
            </div>
            
            <!-- æç¤º -->
            <div class="text-xs text-gray-500 text-center">
                <p>ğŸ“Œ æˆ¿é—´IDç”±6ä½å­—æ¯/æ•°å­—ç»„æˆ</p>
                <p>ğŸ“Œ å¤åˆ¶é“¾æ¥ç›´æ¥é‚€è¯·å¥½å‹åŠ å…¥</p>
                <p>ğŸ“Œ æ•°æ®ä¿å­˜åœ¨æœ¬åœ°ï¼Œåˆ·æ–°ä¸ä¸¢å¤±</p>
            </div>
        </div>
    </div>

    <!-- æ¶‚é¸¦ä¸»ç•Œé¢ï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <div id="doodle-screen" class="flex-1 flex flex-col md:flex-row hidden">
        <!-- å·¦ä¾§å·¥å…·æ  -->
        <aside class="bg-white p-3 shadow-lg flex md:flex-col justify-between gap-3 md:w-16 lg:w-20 flex-wrap md:flex-nowrap z-30">
            <!-- ç»˜ç”»å·¥å…· -->
            <div class="flex md:flex-col gap-2">
                <button class="tool-btn active w-10 h-10 md:w-12 md:h-12 rounded-full flex items-center justify-center bg-gray-100 hover:bg-gray-200 transition" data-tool="pencil" title="é“…ç¬”">
                    <i class="fa fa-pencil text-xl"></i>
                </button>
                <button class="tool-btn w-10 h-10 md:w-12 md:h-12 rounded-full flex items-center justify-center bg-gray-100 hover:bg-gray-200 transition" data-tool="eraser" title="æ©¡çš®æ“¦">
                    <i class="fa fa-eraser text-xl"></i>
                </button>
                <button class="tool-btn w-10 h-10 md:w-12 md:h-12 rounded-full flex items-center justify-center bg-gray-100 hover:bg-gray-200 transition" data-tool="clear" title="æ¸…ç©ºç”»å¸ƒ">
                    <i class="fa fa-trash text-xl"></i>
                </button>
                <button class="tool-btn w-10 h-10 md:w-12 md:h-12 rounded-full flex items-center justify-center bg-gray-100 hover:bg-gray-200 transition" data-tool="save" title="ä¿å­˜ä½œå“">
                    <i class="fa fa-download text-xl"></i>
                </button>
                <button class="tool-btn w-10 h-10 md:w-12 md:h-12 rounded-full flex items-center justify-center bg-gray-100 hover:bg-gray-200 transition" data-tool="share" title="åˆ†äº«æˆ¿é—´">
                    <i class="fa fa-share-alt text-xl"></i>
                </button>
            </div>

            <!-- ç²—ç»†è°ƒèŠ‚ -->
            <div class="flex md:flex-col gap-2 items-center md:items-stretch w-full">
                <label class="text-xs md:text-sm text-center md:mb-1 w-full">ç²—ç»†</label>
                <input type="range" min="1" max="30" value="5" class="w-20 md:w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer" id="line-width">
                <div class="flex gap-1 justify-center">
                    <div class="w-2 h-2 bg-black rounded-full"></div>
                    <div class="w-4 h-4 bg-black rounded-full"></div>
                    <div class="w-6 h-6 bg-black rounded-full"></div>
                </div>
            </div>

            <!-- é¢œè‰²é€‰æ‹© -->
            <div class="flex md:flex-col gap-2">
                <div class="color-btn active w-8 h-8 rounded-full bg-black" data-color="#000000"></div>
                <div class="color-btn w-8 h-8 rounded-full bg-red-500" data-color="#EF4444"></div>
                <div class="color-btn w-8 h-8 rounded-full bg-yellow-400" data-color="#FACC15"></div>
                <div class="color-btn w-8 h-8 rounded-full bg-green-500" data-color="#22C55E"></div>
                <div class="color-btn w-8 h-8 rounded-full bg-blue-500" data-color="#3B82F6"></div>
                <div class="color-btn w-8 h-8 rounded-full bg-purple-500" data-color="#8B5CF6"></div>
                <input type="color" class="w-8 h-8 rounded-full border-0 p-0" id="custom-color" value="#000000">
            </div>
        </aside>

        <!-- ç”»å¸ƒåŒºåŸŸ -->
        <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
            <div class="flex-1 bg-gray-100 flex items-center justify-center p-2 md:p-4">
                <canvas id="doodle-canvas" class="bg-white rounded-xl shadow-md max-w-full max-h-full"></canvas>
            </div>

            <!-- å³ä¾§èŠå¤©æ¡†ï¼ˆç§»åŠ¨ç«¯åº•éƒ¨ï¼‰ -->
            <div class="md:w-80 bg-white shadow-lg flex flex-col h-48 md:h-full">
                <div class="p-2 border-b border-gray-200 flex items-center justify-between">
                    <h3 class="font-bold text-primary flex items-center gap-1">
                        <i class="fa fa-comments"></i> å®æ—¶èŠå¤©
                    </h3>
                    <span id="chat-online" class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">
                        åœ¨çº¿: 1
                    </span>
                </div>
                <div id="chat-messages" class="flex-1 overflow-y-auto p-2 gap-2 flex flex-col"></div>
                <div class="p-2 border-t border-gray-200">
                    <div class="flex gap-2">
                        <input type="text" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
                        <button id="send-chat" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-primary/90 transition">
                            <i class="fa fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ†äº«æ¨¡æ€æ¡†ï¼ˆé»˜è®¤éšè—ï¼‰ -->
    <div id="share-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl p-6 w-11/12 max-w-md">
            <h3 class="text-xl font-bold mb-4 text-primary flex items-center gap-2">
                <i class="fa fa-share-alt"></i> åˆ†äº«æˆ¿é—´
            </h3>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">æˆ¿é—´é“¾æ¥</label>
                <div class="flex">
                    <input type="text" id="room-link" class="flex-1 px-3 py-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-primary" readonly>
                    <button id="copy-link" class="bg-primary text-white px-4 py-2 rounded-r-lg hover:bg-primary/90 transition">
                        å¤åˆ¶
                    </button>
                </div>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-2">æˆ¿é—´ID</label>
                <input type="text" id="share-room-id" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" readonly>
            </div>
            <div class="flex justify-end gap-2">
                <button id="close-share" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 transition">
                    å…³é—­
                </button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€çŠ¶æ€
        const state = {
            roomId: '',
            username: 'ç”¨æˆ·' + Math.floor(Math.random() * 1000),
            isDrawing: false,
            currentTool: 'pencil',
            currentColor: '#000000',
            lineWidth: 5,
            canvasData: [], // å­˜å‚¨ç»˜ç”»å†å²
            chatMessages: [] // å­˜å‚¨èŠå¤©è®°å½•
        };

        // DOMå…ƒç´ 
        const elements = {
            initScreen: document.getElementById('init-screen'),
            doodleScreen: document.getElementById('doodle-screen'),
            createRoomBtn: document.getElementById('create-room-btn'),
            joinRoomBtn: document.getElementById('join-room-btn'),
            joinRoomId: document.getElementById('join-room-id'),
            roomId: document.getElementById('room-id'),
            onlineCount: document.getElementById('online-count'),
            chatOnline: document.getElementById('chat-online'),
            canvas: document.getElementById('doodle-canvas'),
            ctx: document.getElementById('doodle-canvas').getContext('2d'),
            lineWidth: document.getElementById('line-width'),
            customColor: document.getElementById('custom-color'),
            chatMessages: document.getElementById('chat-messages'),
            chatInput: document.getElementById('chat-input'),
            sendChat: document.getElementById('send-chat'),
            shareModal: document.getElementById('share-modal'),
            roomLink: document.getElementById('room-link'),
            shareRoomId: document.getElementById('share-room-id'),
            copyLink: document.getElementById('copy-link'),
            closeShare: document.getElementById('close-share')
        };

        // åˆå§‹åŒ–ç”»å¸ƒ
        function initCanvas() {
            const canvas = elements.canvas;
            const container = canvas.parentElement;
            
            // è®¾ç½®ç”»å¸ƒå¤§å°ï¼ˆé€‚åº”å®¹å™¨ï¼‰
            function resizeCanvas() {
                const containerWidth = container.clientWidth - 30;
                const containerHeight = container.clientHeight - 30;
                canvas.width = Math.max(400, containerWidth);
                canvas.height = Math.max(300, containerHeight);
                redrawCanvas(); // é‡æ–°ç»˜åˆ¶å†å²æ•°æ®
            }

            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            // ç»˜ç”»äº‹ä»¶
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            // è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯æ”¯æŒï¼‰
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const x = touch.clientX - rect.left;
                const y = touch.clientY - rect.top;
                startDrawing({ clientX: touch.clientX, clientY: touch.clientY });
            });
            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                draw({ clientX: touch.clientX, clientY: touch.clientY });
            });
            canvas.addEventListener('touchend', stopDrawing);
            canvas.addEventListener('touchcancel', stopDrawing);
        }

        // å¼€å§‹ç»˜ç”»
        function startDrawing(e) {
            state.isDrawing = true;
            const rect = elements.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // è®°å½•èµ·å§‹ç‚¹
            elements.ctx.beginPath();
            elements.ctx.moveTo(x, y);
            elements.ctx.lineCap = 'round';
            elements.ctx.lineJoin = 'round';
            elements.ctx.strokeStyle = state.currentTool === 'eraser' ? '#FFFFFF' : state.currentColor;
            elements.ctx.lineWidth = state.currentTool === 'eraser' ? state.lineWidth * 2 : state.lineWidth;

            // ä¿å­˜åˆ°å†å²è®°å½•
            state.canvasData.push({
                type: 'start',
                x, y,
                color: elements.ctx.strokeStyle,
                width: elements.ctx.lineWidth,
                timestamp: Date.now()
            });
        }

        // ç»˜ç”»ä¸­
        function draw(e) {
            if (!state.isDrawing) return;

            const rect = elements.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            // ç»˜åˆ¶çº¿æ¡
            elements.ctx.lineTo(x, y);
            elements.ctx.stroke();

            // ä¿å­˜åˆ°å†å²è®°å½•
            state.canvasData.push({
                type: 'draw',
                x, y,
                timestamp: Date.now()
            });

            // åŒæ­¥åˆ°localStorage
            saveToLocalStorage();
        }

        // åœæ­¢ç»˜ç”»
        function stopDrawing() {
            if (state.isDrawing) {
                state.isDrawing = false;
                elements.ctx.closePath();

                // ä¿å­˜åˆ°å†å²è®°å½•
                state.canvasData.push({
                    type: 'end',
                    timestamp: Date.now()
                });

                // åŒæ­¥åˆ°localStorage
                saveToLocalStorage();
            }
        }

        // é‡æ–°ç»˜åˆ¶ç”»å¸ƒï¼ˆä»å†å²è®°å½•ï¼‰
        function redrawCanvas() {
            const ctx = elements.ctx;
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            if (state.canvasData.length === 0) return;

            let currentPath = null;
            state.canvasData.forEach(item => {
                if (item.type === 'start') {
                    currentPath = item;
                    ctx.beginPath();
                    ctx.moveTo(item.x, item.y);
                    ctx.strokeStyle = item.color;
                    ctx.lineWidth = item.width;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                } else if (item.type === 'draw' && currentPath) {
                    ctx.lineTo(item.x, item.y);
                    ctx.stroke();
                } else if (item.type === 'end') {
                    ctx.closePath();
                    currentPath = null;
                }
            });
        }

        // ç”Ÿæˆ6ä½æˆ¿é—´ID
        function generateRoomId() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
            let roomId = '';
            for (let i = 0; i < 6; i++) {
                roomId += chars[Math.floor(Math.random() * chars.length)];
            }
            return roomId;
        }

        // ä¿å­˜æ•°æ®åˆ°localStorage
        function saveToLocalStorage() {
            const data = {
                canvasData: state.canvasData,
                chatMessages: state.chatMessages,
                lastActive: Date.now()
            };
            localStorage.setItem(`doodle_${state.roomId}`, JSON.stringify(data));
        }

        // ä»localStorageåŠ è½½æ•°æ®
        function loadFromLocalStorage() {
            const data = localStorage.getItem(`doodle_${state.roomId}`);
            if (data) {
                const parsed = JSON.parse(data);
                state.canvasData = parsed.canvasData || [];
                state.chatMessages = parsed.chatMessages || [];
                redrawCanvas();
                renderChatMessages();
            }
        }

        // æ¸²æŸ“èŠå¤©æ¶ˆæ¯
        function renderChatMessages() {
            elements.chatMessages.innerHTML = '';
            state.chatMessages.forEach(msg => {
                const isSelf = msg.username === state.username;
                const messageEl = document.createElement('div');
                messageEl.className = `chat-message ${isSelf ? 'chat-self' : 'chat-other'} p-2 bubble self-${isSelf ? 'end' : 'start'}`;
                
                const header = document.createElement('div');
                header.className = `text-xs mb-1 ${isSelf ? 'text-right' : 'text-left'}`;
                header.textContent = msg.username;
                
                const content = document.createElement('div');
                content.className = 'text-sm';
                content.textContent = msg.content;
                
                messageEl.appendChild(header);
                messageEl.appendChild(content);
                elements.chatMessages.appendChild(messageEl);
            });
            // æ»šåŠ¨åˆ°åº•éƒ¨
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }

        // å‘é€èŠå¤©æ¶ˆæ¯
        function sendChatMessage() {
            const content = elements.chatInput.value.trim();
            if (!content) return;

            const message = {
                username: state.username,
                content,
                timestamp: Date.now()
            };

            state.chatMessages.push(message);
            renderChatMessages();
            saveToLocalStorage();
            elements.chatInput.value = '';
        }

        // åˆå§‹åŒ–å·¥å…·äº‹ä»¶
        function initTools() {
            // å·¥å…·æŒ‰é’®
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // ç§»é™¤å…¶ä»–æŒ‰é’®çš„activeçŠ¶æ€
                    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                    // æ·»åŠ å½“å‰æŒ‰é’®çš„activeçŠ¶æ€
                    btn.classList.add('active');
                    // è®¾ç½®å½“å‰å·¥å…·
                    state.currentTool = btn.dataset.tool;

                    // å·¥å…·æ“ä½œ
                    switch (state.currentTool) {
                        case 'clear':
                            if (confirm('ç¡®å®šè¦æ¸…ç©ºç”»å¸ƒå—ï¼Ÿ')) {
                                state.canvasData = [];
                                elements.ctx.clearRect(0, 0, elements.canvas.width, elements.canvas.height);
                                saveToLocalStorage();
                            }
                            break;
                        case 'save':
                            const link = document.createElement('a');
                            link.download = `æ¶‚é¸¦ä½œå“_${state.roomId}.png`;
                            link.href = elements.canvas.toDataURL('image/png');
                            link.click();
                            break;
                        case 'share':
                            elements.shareRoomId.value = state.roomId;
                            elements.roomLink.value = window.location.href;
                            elements.shareModal.classList.remove('hidden');
                            break;
                    }
                });
            });

            // é¢œè‰²æŒ‰é’®
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    state.currentColor = btn.dataset.color;
                    elements.customColor.value = btn.dataset.color;
                });
            });

            // è‡ªå®šä¹‰é¢œè‰²
            elements.customColor.addEventListener('input', (e) => {
                state.currentColor = e.target.value;
                document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            });

            // çº¿æ¡ç²—ç»†
            elements.lineWidth.addEventListener('input', (e) => {
                state.lineWidth = parseInt(e.target.value);
            });

            // èŠå¤©å‘é€
            elements.sendChat.addEventListener('click', sendChatMessage);
            elements.chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });

            // å¤åˆ¶é“¾æ¥
            elements.copyLink.addEventListener('click', () => {
                elements.roomLink.select();
                document.execCommand('copy');
                alert('é“¾æ¥å·²å¤åˆ¶ï¼');
            });

            // å…³é—­åˆ†äº«æ¨¡æ€æ¡†
            elements.closeShare.addEventListener('click', () => {
                elements.shareModal.classList.add('hidden');
            });
        }

        // è§£æURLå‚æ•°ä¸­çš„æˆ¿é—´ID
        function parseRoomIdFromUrl() {
            const params = new URLSearchParams(window.location.search);
            return params.get('room');
        }

        // åˆå§‹åŒ–æˆ¿é—´
        function initRoom(roomId) {
            state.roomId = roomId;
            elements.roomId.textContent = roomId;
            
            // æ›´æ–°URLï¼ˆæ·»åŠ æˆ¿é—´å‚æ•°ï¼‰
            const url = new URL(window.location.href);
            url.searchParams.set('room', roomId);
            window.history.pushState({}, '', url);

            // åŠ è½½æ•°æ®
            loadFromLocalStorage();

            // åˆ‡æ¢ç•Œé¢
            elements.initScreen.classList.add('hidden');
            elements.doodleScreen.classList.remove('hidden');
            elements.roomStatus.classList.remove('hidden');

            // æ¨¡æ‹Ÿåœ¨çº¿äººæ•°ï¼ˆåŸºäºlocalStorageä¸­æ´»è·ƒçš„ç”¨æˆ·ï¼‰
            updateOnlineCount();

            // å®šæ—¶åŒæ­¥æ•°æ®ï¼ˆæ¯2ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰
            setInterval(() => {
                loadFromLocalStorage();
                updateOnlineCount();
            }, 2000);
        }

        // æ›´æ–°åœ¨çº¿äººæ•°ï¼ˆæ¨¡æ‹Ÿï¼‰
        function updateOnlineCount() {
            // ç®€å•æ¨¡æ‹Ÿï¼šç»Ÿè®¡æ‰€æœ‰æˆ¿é—´çš„æ´»è·ƒç”¨æˆ·ï¼ˆå®é™…å¯ä¼˜åŒ–ä¸ºIPç»Ÿè®¡ï¼‰
            let count = 1; // è‡³å°‘è‡ªå·±åœ¨çº¿
            const allKeys = Object.keys(localStorage);
            const roomKeys = allKeys.filter(key => key.startsWith(`doodle_${state.roomId}`));
            
            if (roomKeys.length > 0) {
                count = Math.min(4, Math.floor(Math.random() * 3) + 1); // æ¨¡æ‹Ÿ1-4äººåœ¨çº¿
            }

            elements.onlineCount.textContent = count;
            elements.chatOnline.textContent = `åœ¨çº¿: ${count}`;
        }

        // åˆå§‹åŒ–äº‹ä»¶ç›‘å¬
        function initEvents() {
            // åˆ›å»ºæˆ¿é—´
            elements.createRoomBtn.addEventListener('click', () => {
                const roomId = generateRoomId();
                initRoom(roomId);
            });

            // åŠ å…¥æˆ¿é—´
            elements.joinRoomBtn.addEventListener('click', () => {
                const roomId = elements.joinRoomId.value.trim();
                if (!roomId || roomId.length !== 6) {
                    alert('è¯·è¾“å…¥æœ‰æ•ˆçš„6ä½æˆ¿é—´IDï¼');
                    return;
                }
                initRoom(roomId);
            });

            // å›è½¦åŠ å…¥æˆ¿é—´
            elements.joinRoomId.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    elements.joinRoomBtn.click();
                }
            });

            // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æœ‰æˆ¿é—´ID
            const urlRoomId = parseRoomIdFromUrl();
            if (urlRoomId && urlRoomId.length === 6) {
                initRoom(urlRoomId);
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        function initApp() {
            initCanvas();
            initTools();
            initEvents();
        }

        // å¯åŠ¨åº”ç”¨
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>